{% extends 'music/base.html' %}
{% block title %}Reproductor{% endblock %}

{% block content %}
<input type="hidden" id="listaCanciones" value="{{ lista_ids }}">
<input type="hidden" id="currentId" value="{% if cancion %}{{ cancion.id }}{% endif %}">

<div class="player">
  {% if cancion and cancion.portada %}
  <div class="background-blur" style="background-image: url('{{ cancion.portada.url }}');"></div>
  {% endif %}

  <div class="player_inner">

    <div class="player_inner__top">
      <div class="header-left">
        <a href="{% url 'library' %}" class="btn-library">
          <i class="bi bi-chevron-left"></i>
          <span>BIBLIOTECA</span>
        </a>
      </div>

      <div class="t_mid_search">
        <div class="search-wrapper">
          <form id="searchForm" action="{% url 'buscar' %}" method="GET" class="search-box">
            <input type="hidden" name="current_id" value="{% if cancion %}{{ cancion.id }}{% endif %}">
            <i class="bi bi-search"></i>
            <input type="text" id="searchInput" name="q" placeholder="Buscar canción..." autocomplete="off">
          </form>
          <div id="suggestionsBox"></div>
        </div>
      </div>

      <div class="header-right">
        {% if user.is_authenticated %}
        <span class="user-name">{{ user.username }}</span>
        {% for group in user.groups.all %}
        <span class="badge bg-secondary" style="font-size: 0.7em;">{{ group.name }}</span>
        {% endfor %}
        <i class="bi bi-person-circle"></i>

        <form action="{% url 'logout' %}" method="post" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-outline-light ms-2"
            style="border-radius: 20px; font-size: 0.7rem;">Logout</button>
        </form>
        {% else %}
        <a href="{% url 'login' %}" class="btn btn-sm btn-primary" style="border-radius: 20px;">Login</a>
        {% endif %}
      </div>
    </div>

    <div class="player_inner__middle">
      {% if cancion %}
      <div class="details">
        {% if cancion.portada %}
        <img src="{{ cancion.portada.url }}" class="cover" alt="{{ cancion.titulo }}">
        {% else %}
        <div class="no-cover"><i class="bi bi-music-note-beamed"></i></div>
        {% endif %}

        <div class="song-info">
          <h2>{{ cancion.titulo }}</h2>
          <h3>
            {% for artista in cancion.artistas.all %}
            {{ artista.nombre }}{% if not forloop.last %}, {% endif %}
            {% empty %}Sin Artista{% endfor %}
          </h3>
        </div>

        <audio id="audioPlayer" preload="metadata" autoplay>
          {% if cancion.archivo %}
          <source src="{{ cancion.archivo.url }}" type="audio/mpeg">
          {% endif %}
        </audio>
      </div>
      {% else %}
      <!-- Mostrar cuando no hay canción disponible -->
      <div class="details">
        <div class="no-cover"><i class="bi bi-music-note-beamed"></i></div>
        <div class="song-info">
          <h2>No hay canciones disponibles</h2>
          <h3>Agrega canciones a tu biblioteca</h3>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="player_inner__bottom">
      <div class="playbar-container">
        <div class="playbar">
          <div class="playbar_inner"></div>
        </div>
        <!-- IDs agregados para los elementos de tiempo -->
        <div class="time-info">
          <div class="playbar_left"><span id="currentTime">0:00</span></div>
          <div class="playbar_right"><span id="durationTime">--:--</span></div>
        </div>
      </div>

      <div class="bottom-controls-row">
        <div class="side-placeholder"></div>

        <div class="controls">
          <i class="bi bi-shuffle" id="shuffleBtn"></i>
          <i class="bi bi-skip-backward-fill" id="prevBtn"></i>
          <i class="bi bi-play-circle-fill play"></i>
          <i class="bi bi-skip-forward-fill" id="nextBtn"></i>
          <i class="bi bi-repeat" id="repeatBtn"></i>
        </div>

        <div class="volume-container">
          <div class="volume-box">
            <i class="bi bi-volume-down-fill"></i>
            <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="0.5">
            <i class="bi bi-volume-up-fill"></i>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

{% endblock %}